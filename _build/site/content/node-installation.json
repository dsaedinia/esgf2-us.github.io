{"version":2,"kind":"Article","sha256":"a9f78d514486aaef175fd6effd3d015084f23436613b22ecc9387eefbd3cf32b","slug":"node-installation","location":"/Node-Installation.md","dependencies":[],"frontmatter":{"title":"Node Installation Guide","github":"https://github.com/esgf2-us/esgf2-us.github.io","keywords":[],"numbering":{"title":{"offset":1}},"edit_url":"https://github.com/esgf2-us/esgf2-us.github.io/blob/new-Architecture/Node-Installation.md","exports":[{"format":"md","filename":"Node-Installation.md","url":"/Node-Installation-5a2c3dc5f2df3fd26897b30912deecaf.md"}]},"mdast":{"type":"root","children":[{"type":"block","children":[{"type":"heading","depth":2,"position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"Data node configuration","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"an8fg2y7Wp"}],"identifier":"data-node-configuration","label":"Data node configuration","html_id":"data-node-configuration","implicit":true,"key":"EdJobyP08l"},{"type":"paragraph","position":{"start":{"line":7,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"text","value":"This section describes the most commonly used data node configuration options.\nFor a full list of available variables, please consult the chart at\n","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"i8QQTfD3c0"},{"type":"link","url":"../../deploy/kubernetes/chart/values.yaml","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"text","value":"values.yaml","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"nifKvCFZkB"}],"urlSource":"../../deploy/kubernetes/chart/values.yaml","key":"BQ1WAk2AEA"},{"type":"text","value":".","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"RRntLEx1kv"}],"key":"Gj1xh2Djb1"},{"type":"comment","value":" TOC depthFrom:2 ","key":"FPM5zA78e8"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":13,"column":1},"end":{"line":18,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":13,"column":1},"end":{"line":13,"column":1}},"children":[{"type":"crossReference","position":{"start":{"line":13,"column":1},"end":{"line":13,"column":1}},"children":[{"type":"text","value":"Configuring the available datasets","position":{"start":{"line":13,"column":1},"end":{"line":13,"column":1}},"key":"CTms8W4R4d"}],"identifier":"configuring-the-available-datasets","label":"configuring-the-available-datasets","kind":"heading","template":"{name}","resolved":true,"html_id":"configuring-the-available-datasets","key":"fOXVWSSWzc"}],"key":"UKQ3fujnNY"},{"type":"listItem","spread":true,"position":{"start":{"line":14,"column":1},"end":{"line":14,"column":1}},"children":[{"type":"crossReference","position":{"start":{"line":14,"column":1},"end":{"line":14,"column":1}},"children":[{"type":"text","value":"Fowarding access logs","position":{"start":{"line":14,"column":1},"end":{"line":14,"column":1}},"key":"APKyaVuxxN"}],"identifier":"fowarding-access-logs","label":"fowarding-access-logs","kind":"heading","template":"{name}","resolved":true,"html_id":"fowarding-access-logs","key":"iz09w6ucqE"}],"key":"UYDayLetRB"},{"type":"listItem","spread":true,"position":{"start":{"line":15,"column":1},"end":{"line":15,"column":1}},"children":[{"type":"crossReference","position":{"start":{"line":15,"column":1},"end":{"line":15,"column":1}},"children":[{"type":"text","value":"Enabling demand-based autoscaling","position":{"start":{"line":15,"column":1},"end":{"line":15,"column":1}},"key":"bcheEXzHE6"}],"identifier":"enabling-demand-based-autoscaling","label":"enabling-demand-based-autoscaling","kind":"heading","template":"{name}","resolved":true,"html_id":"enabling-demand-based-autoscaling","key":"GBtY79Cvme"}],"key":"XczFWzwByb"},{"type":"listItem","spread":true,"position":{"start":{"line":16,"column":1},"end":{"line":16,"column":1}},"children":[{"type":"crossReference","position":{"start":{"line":16,"column":1},"end":{"line":16,"column":1}},"children":[{"type":"text","value":"Using existing THREDDS catalogs","position":{"start":{"line":16,"column":1},"end":{"line":16,"column":1}},"key":"eXwIxJn0KT"}],"identifier":"using-existing-thredds-catalogs","label":"using-existing-thredds-catalogs","kind":"heading","template":"{name}","resolved":true,"html_id":"using-existing-thredds-catalogs","key":"ZW7FZqeRAe"}],"key":"Zq9TZhMxf8"},{"type":"listItem","spread":true,"position":{"start":{"line":17,"column":1},"end":{"line":18,"column":1}},"children":[{"type":"crossReference","position":{"start":{"line":17,"column":1},"end":{"line":17,"column":1}},"children":[{"type":"text","value":"Improving pod startup time for large catalogs","position":{"start":{"line":17,"column":1},"end":{"line":17,"column":1}},"key":"kvTz70i4g3"}],"identifier":"improving-pod-startup-time-for-large-catalogs","label":"improving-pod-startup-time-for-large-catalogs","kind":"heading","template":"{name}","resolved":true,"html_id":"improving-pod-startup-time-for-large-catalogs","key":"z9u5xdkWRs"}],"key":"D2q82pjK5v"}],"key":"lRIm3d4bWi"},{"type":"comment","value":" /TOC ","key":"jKUEYHd150"},{"type":"heading","depth":3,"position":{"start":{"line":21,"column":1},"end":{"line":21,"column":1}},"children":[{"type":"text","value":"Configuring the available datasets","position":{"start":{"line":21,"column":1},"end":{"line":21,"column":1}},"key":"tK1zIOzOlg"}],"identifier":"configuring-the-available-datasets","label":"Configuring the available datasets","html_id":"configuring-the-available-datasets","implicit":true,"key":"L3QWVZ5mz5"},{"type":"paragraph","position":{"start":{"line":23,"column":1},"end":{"line":26,"column":1}},"children":[{"type":"text","value":"By default, the data node uses a catalog-free configuration where the available data is defined simply by\na series of datasets. For each dataset, all files under the specified path will be served using both\nOPeNDAP (for NetCDF files) and plain HTTP. The browsable interface and OPeNDAP are provided by\nTHREDDS and direct file serving is provided by Nginx.","position":{"start":{"line":23,"column":1},"end":{"line":23,"column":1}},"key":"BbX5y5b5K8"}],"key":"meZlfZfqJV"},{"type":"paragraph","position":{"start":{"line":28,"column":1},"end":{"line":28,"column":1}},"children":[{"type":"text","value":"The configuration of the datasets is done using two variables:","position":{"start":{"line":28,"column":1},"end":{"line":28,"column":1}},"key":"oKF2KXNYeZ"}],"key":"ohZ2ue8qXc"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":30,"column":1},"end":{"line":40,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":30,"column":1},"end":{"line":35,"column":1}},"children":[{"type":"inlineCode","value":"data.mounts","position":{"start":{"line":30,"column":1},"end":{"line":30,"column":1}},"key":"P5IYVDiJS0"},{"type":"text","value":": List of volumes to mount into the container. Each item should contain the keys:","position":{"start":{"line":30,"column":1},"end":{"line":30,"column":1}},"key":"kQPEzqOpDQ"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":31,"column":1},"end":{"line":35,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":31,"column":1},"end":{"line":31,"column":1}},"children":[{"type":"inlineCode","value":"mountPath","position":{"start":{"line":31,"column":1},"end":{"line":31,"column":1}},"key":"J488LXT9MW"},{"type":"text","value":": The path to mount the volume inside the container","position":{"start":{"line":31,"column":1},"end":{"line":31,"column":1}},"key":"Bo23rkTDPg"}],"key":"d3N9zZnHZB"},{"type":"listItem","spread":true,"position":{"start":{"line":32,"column":1},"end":{"line":33,"column":1}},"children":[{"type":"inlineCode","value":"volumeSpec","position":{"start":{"line":32,"column":1},"end":{"line":32,"column":1}},"key":"yOzDrdKNuv"},{"type":"text","value":": A ","position":{"start":{"line":32,"column":1},"end":{"line":32,"column":1}},"key":"bgAx6dl0uv"},{"type":"link","url":"https://kubernetes.io/docs/concepts/storage/volumes/","position":{"start":{"line":32,"column":1},"end":{"line":32,"column":1}},"children":[{"type":"text","value":"Kubernetes volume specification","position":{"start":{"line":32,"column":1},"end":{"line":32,"column":1}},"key":"ERFqQozqko"}],"urlSource":"https://kubernetes.io/docs/concepts/storage/volumes/","key":"jgUzpOzo8I"},{"type":"text","value":" for\nthe volume containing the data","position":{"start":{"line":32,"column":1},"end":{"line":32,"column":1}},"key":"dk4fvLW4h4"}],"key":"w8tEaUaBZ5"},{"type":"listItem","spread":true,"position":{"start":{"line":34,"column":1},"end":{"line":34,"column":1}},"children":[{"type":"inlineCode","value":"name","position":{"start":{"line":34,"column":1},"end":{"line":34,"column":1}},"key":"QJ84bwnrew"},{"type":"text","value":" (optional): A name for the volume - by default, a name is derived from the ","position":{"start":{"line":34,"column":1},"end":{"line":34,"column":1}},"key":"Opgs3oFsqF"},{"type":"inlineCode","value":"mountPath","position":{"start":{"line":34,"column":1},"end":{"line":34,"column":1}},"key":"rKpNF1m5Ws"}],"key":"j0e2azpf7g"},{"type":"listItem","spread":true,"position":{"start":{"line":35,"column":1},"end":{"line":35,"column":1}},"children":[{"type":"inlineCode","value":"mountOptions","position":{"start":{"line":35,"column":1},"end":{"line":35,"column":1}},"key":"hHyycMqzl6"},{"type":"text","value":" (optional): Options for the volume mount, e.g. ","position":{"start":{"line":35,"column":1},"end":{"line":35,"column":1}},"key":"knzygUeRKg"},{"type":"inlineCode","value":"mountPropagation","position":{"start":{"line":35,"column":1},"end":{"line":35,"column":1}},"key":"NNhKj5hq4C"},{"type":"text","value":" for ","position":{"start":{"line":35,"column":1},"end":{"line":35,"column":1}},"key":"GMApDA3YUA"},{"type":"inlineCode","value":"hostPath","position":{"start":{"line":35,"column":1},"end":{"line":35,"column":1}},"key":"FBNHEAHa2m"},{"type":"text","value":" volumes","position":{"start":{"line":35,"column":1},"end":{"line":35,"column":1}},"key":"tIB194FMV0"}],"key":"NdkPcaqApQ"}],"key":"l244WVW23p"}],"key":"dVOXWgFozC"},{"type":"listItem","spread":true,"position":{"start":{"line":36,"column":1},"end":{"line":40,"column":1}},"children":[{"type":"inlineCode","value":"data.datasets","position":{"start":{"line":36,"column":1},"end":{"line":36,"column":1}},"key":"gpG7Zalv6h"},{"type":"text","value":": List of datasets to expose. Each item should contain the keys:","position":{"start":{"line":36,"column":1},"end":{"line":36,"column":1}},"key":"oK47sJxE0K"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":37,"column":1},"end":{"line":40,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":37,"column":1},"end":{"line":37,"column":1}},"children":[{"type":"inlineCode","value":"name","position":{"start":{"line":37,"column":1},"end":{"line":37,"column":1}},"key":"mwxdz0X2Dx"},{"type":"text","value":": The human-readable name of the dataset, displayed in the THREDDS UI","position":{"start":{"line":37,"column":1},"end":{"line":37,"column":1}},"key":"QDkLhyyslH"}],"key":"Ru9cNAQHqT"},{"type":"listItem","spread":true,"position":{"start":{"line":38,"column":1},"end":{"line":38,"column":1}},"children":[{"type":"inlineCode","value":"path","position":{"start":{"line":38,"column":1},"end":{"line":38,"column":1}},"key":"giIYYpkNkI"},{"type":"text","value":": The URL path part for the dataset","position":{"start":{"line":38,"column":1},"end":{"line":38,"column":1}},"key":"AjnDQtQ0vI"}],"key":"J5KnVUNKhF"},{"type":"listItem","spread":true,"position":{"start":{"line":39,"column":1},"end":{"line":40,"column":1}},"children":[{"type":"inlineCode","value":"location","position":{"start":{"line":39,"column":1},"end":{"line":39,"column":1}},"key":"oTEMPO79tq"},{"type":"text","value":": The directory path to the root of the dataset in the container","position":{"start":{"line":39,"column":1},"end":{"line":39,"column":1}},"key":"PxYnnUQJ2G"}],"key":"pxfwwR7J0J"}],"key":"sjBuhX9ccQ"}],"key":"uXMVLdz1t1"}],"key":"S91h6ZxMsW"},{"type":"admonition","position":{"start":{"line":41,"column":1},"end":{"line":47,"column":1}},"children":[{"type":"admonitionTitle","children":[{"type":"text","value":"Warning","key":"LuLVwpeLAm"}],"key":"vioGqc8BH7"},{"type":"paragraph","position":{"start":{"line":41,"column":1},"end":{"line":41,"column":1}},"children":[],"key":"A1hdZZx5z3"},{"type":"paragraph","position":{"start":{"line":43,"column":1},"end":{"line":44,"column":1}},"children":[{"type":"text","value":"When using ","position":{"start":{"line":43,"column":1},"end":{"line":43,"column":1}},"key":"WZ2YuAwsSw"},{"type":"inlineCode","value":"hostPath","position":{"start":{"line":43,"column":1},"end":{"line":43,"column":1}},"key":"zivmc0EnwQ"},{"type":"text","value":" volumes, the data must exist at the same path on all cluster nodes where the THREDDS\nor file server pods might be scheduled.","position":{"start":{"line":43,"column":1},"end":{"line":43,"column":1}},"key":"GbOSU5SnwM"}],"key":"Vh8Ztqz11r"},{"type":"paragraph","position":{"start":{"line":46,"column":1},"end":{"line":47,"column":1}},"children":[{"type":"text","value":"If your data is on a shared filesystem, just mount the filesystem on your cluster nodes as you would\nwith any other host.","position":{"start":{"line":46,"column":1},"end":{"line":46,"column":1}},"key":"egD2lX5jc4"}],"key":"w0TJL9RyZR"}],"kind":"warning","class":"simple","key":"xohI9Tg53q"},{"type":"paragraph","position":{"start":{"line":49,"column":1},"end":{"line":49,"column":1}},"children":[{"type":"text","value":"These variables should be defined in your ","position":{"start":{"line":49,"column":1},"end":{"line":49,"column":1}},"key":"Exyr6O4XRY"},{"type":"inlineCode","value":"values.yaml","position":{"start":{"line":49,"column":1},"end":{"line":49,"column":1}},"key":"Z0hDpMVJNK"},{"type":"text","value":", e.g.:","position":{"start":{"line":49,"column":1},"end":{"line":49,"column":1}},"key":"YNeaMt66qH"}],"key":"xKTCqMNpYR"},{"type":"code","lang":"yaml","value":"data:\n  mounts:\n    # This uses a hostPath volume to mount /datacentre/archive on the host as /data in the container\n    - mountPath: /data\n      volumeSpec:\n        hostPath:\n          path: /datacentre/archive\n      mountOptions:\n        # mountPropagation is particularly important if the filesystem has automounted sub-mounts\n        mountPropagation: HostToContainer\n\n  datasets:\n    # This will expose files at /data/cmip6/[path] in the container\n    # as http://esgf-data.example.org/thredds/{dodsC,fileServer}/esg_cmip6/[path]\n    - name: CMIP6\n      path: esg_cmip6\n      location: /data/cmip6\n    # Similarly, this exposes files at /data/cordex/[path] in the container\n    # as http://esgf-data.example.org/thredds/{dodsC,fileServer}/esg_cordex/[path]\n    - name: CORDEX\n      path: esg_cordex\n      location: /data/cordex","position":{"start":{"line":51,"column":1},"end":{"line":74,"column":1}},"key":"pk7dlpDZg5"},{"type":"heading","depth":3,"position":{"start":{"line":76,"column":1},"end":{"line":76,"column":1}},"children":[{"type":"text","value":"Using S3 buckets for data","position":{"start":{"line":76,"column":1},"end":{"line":76,"column":1}},"key":"UJiPP2KFKx"}],"identifier":"using-s3-buckets-for-data","label":"Using S3 buckets for data","html_id":"using-s3-buckets-for-data","implicit":true,"key":"BclWD27JOG"},{"type":"paragraph","position":{"start":{"line":78,"column":1},"end":{"line":78,"column":1}},"children":[{"type":"text","value":"An S3 location for a dataset can be specified using ","position":{"start":{"line":78,"column":1},"end":{"line":78,"column":1}},"key":"NbryoETqzY"},{"type":"inlineCode","value":"s3Location","position":{"start":{"line":78,"column":1},"end":{"line":78,"column":1}},"key":"ioWk9kYc76"},{"type":"text","value":" instead of ","position":{"start":{"line":78,"column":1},"end":{"line":78,"column":1}},"key":"PpKP1L2rLS"},{"type":"inlineCode","value":"location","position":{"start":{"line":78,"column":1},"end":{"line":78,"column":1}},"key":"yXmbvMuIKH"},{"type":"text","value":" in the yaml config, e.g.:","position":{"start":{"line":78,"column":1},"end":{"line":78,"column":1}},"key":"dNZckj3SAK"}],"key":"pf89mxK8gB"},{"type":"code","lang":"yaml","value":"  datasets:\n    - name: CMIP6\n      path: esg_cmip6\n      s3Location:\n        host: example.com\n        port: 443\n        bucket: bucket_name\n        dataPath: path/to/files","position":{"start":{"line":80,"column":1},"end":{"line":89,"column":1}},"key":"BU1FD5ippa"},{"type":"paragraph","position":{"start":{"line":91,"column":1},"end":{"line":91,"column":1}},"children":[{"type":"text","value":"We don’t currently support adding security parameters for accessing secured S3 buckets.","position":{"start":{"line":91,"column":1},"end":{"line":91,"column":1}},"key":"AmxjM36uTT"}],"key":"dTlnpXiOl0"},{"type":"heading","depth":3,"position":{"start":{"line":93,"column":1},"end":{"line":93,"column":1}},"children":[{"type":"text","value":"Fowarding access logs","position":{"start":{"line":93,"column":1},"end":{"line":93,"column":1}},"key":"HE3glMkkXo"}],"identifier":"fowarding-access-logs","label":"Fowarding access logs","html_id":"fowarding-access-logs","implicit":true,"key":"oxKVleB7GQ"},{"type":"paragraph","position":{"start":{"line":95,"column":1},"end":{"line":97,"column":1}},"children":[{"type":"text","value":"The THREDDS and Nginx file server components can be configured to forward access logs to\n","position":{"start":{"line":95,"column":1},"end":{"line":95,"column":1}},"key":"ojfmeaCxaq"},{"type":"link","url":"https://www.cmcc.it/","position":{"start":{"line":95,"column":1},"end":{"line":95,"column":1}},"children":[{"type":"text","value":"CMCC","position":{"start":{"line":95,"column":1},"end":{"line":95,"column":1}},"key":"rC6uUxkVVk"}],"urlSource":"https://www.cmcc.it/","key":"QjYOuzedbS"},{"type":"text","value":" for processing in order to produce download statistics for\nthe federation.","position":{"start":{"line":95,"column":1},"end":{"line":95,"column":1}},"key":"RW9JKoXACe"}],"key":"ghbevHBfqZ"},{"type":"paragraph","position":{"start":{"line":99,"column":1},"end":{"line":100,"column":1}},"children":[{"type":"text","value":"Before enabling this functionality you must first contact CMCC to arrange for the IP addresses\nof your Kubernetes nodes, as visible from the internet, to be whitelisted.","position":{"start":{"line":99,"column":1},"end":{"line":99,"column":1}},"key":"Dqz6wDlgqN"}],"key":"GiNO8AMHPi"},{"type":"blockquote","position":{"start":{"line":102,"column":1},"end":{"line":106,"column":1}},"children":[{"type":"paragraph","position":{"start":{"line":102,"column":1},"end":{"line":104,"column":1}},"children":[{"type":"text","value":"If your Kubernetes nodes are not directly exposed to the internet then they are probably using\n","position":{"start":{"line":102,"column":1},"end":{"line":102,"column":1}},"key":"pvHcSOccXX"},{"type":"link","url":"https://en.wikipedia.org/wiki/Network_address_translation","position":{"start":{"line":102,"column":1},"end":{"line":102,"column":1}},"children":[{"type":"text","value":"Network Address Translation (NAT)","position":{"start":{"line":102,"column":1},"end":{"line":102,"column":1}},"key":"z5mtM12UyQ"}],"urlSource":"https://en.wikipedia.org/wiki/Network_address_translation","data":{"page":"Network_address_translation","wiki":"https://en.wikipedia.org/","lang":"en"},"internal":false,"protocol":"wiki","key":"zTvuc12Ujs"},{"type":"text","value":"\nwhen accessing resources on the internet.","position":{"start":{"line":102,"column":1},"end":{"line":102,"column":1}},"key":"NdVEQtJX1M"}],"key":"u2C0FEmkSh"},{"type":"paragraph","position":{"start":{"line":106,"column":1},"end":{"line":106,"column":1}},"children":[{"type":"text","value":"In this case, the address that you need to give to CMCC is the translated address.","position":{"start":{"line":106,"column":1},"end":{"line":106,"column":1}},"key":"ExgwxNPF1R"}],"key":"MTWKyAse99"}],"key":"nBv1ZLqz2T"},{"type":"paragraph","position":{"start":{"line":108,"column":1},"end":{"line":109,"column":1}},"children":[{"type":"text","value":"To enable the forwarding of access logs for THREDDS and Nginx file server pods, add the following\nto your ","position":{"start":{"line":108,"column":1},"end":{"line":108,"column":1}},"key":"rXvGVE6A2n"},{"type":"inlineCode","value":"values.yaml","position":{"start":{"line":108,"column":1},"end":{"line":108,"column":1}},"key":"IuNnCaK0RD"},{"type":"text","value":":","position":{"start":{"line":108,"column":1},"end":{"line":108,"column":1}},"key":"LmakQeajSB"}],"key":"mtkaK1AVbm"},{"type":"code","lang":"yaml","value":"data:\n  accessLogSidecar:\n    enabled: true","position":{"start":{"line":111,"column":1},"end":{"line":115,"column":1}},"key":"qPvGLr7BHa"},{"type":"paragraph","position":{"start":{"line":117,"column":1},"end":{"line":118,"column":1}},"children":[{"type":"text","value":"Additional variables are available to configure the server to which logs should be forwarded,\nhowever the vast majority of deployments will not need to change these.","position":{"start":{"line":117,"column":1},"end":{"line":117,"column":1}},"key":"UdCuN7Vs5E"}],"key":"PpfkzW4avS"},{"type":"heading","depth":3,"position":{"start":{"line":120,"column":1},"end":{"line":120,"column":1}},"children":[{"type":"text","value":"Enabling demand-based autoscaling","position":{"start":{"line":120,"column":1},"end":{"line":120,"column":1}},"key":"FqWI8Wn77p"}],"identifier":"enabling-demand-based-autoscaling","label":"Enabling demand-based autoscaling","html_id":"enabling-demand-based-autoscaling","implicit":true,"key":"dRflCyHwlJ"},{"type":"paragraph","position":{"start":{"line":122,"column":1},"end":{"line":125,"column":1}},"children":[{"type":"text","value":"Kubernetes allows the number of pods backing a service to be scaled up and down automatically using\na ","position":{"start":{"line":122,"column":1},"end":{"line":122,"column":1}},"key":"aOTudMOLoU"},{"type":"link","url":"https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/","position":{"start":{"line":122,"column":1},"end":{"line":122,"column":1}},"children":[{"type":"text","value":"Horizontal Pod Autoscaler (HPA)","position":{"start":{"line":122,"column":1},"end":{"line":122,"column":1}},"key":"m0qpeMMmg4"}],"urlSource":"https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/","key":"u36JRrIDAF"},{"type":"text","value":".\nThis allows the service to respond to spikes in demand by creating more pods to respond to requests.\nA Kubernetes ","position":{"start":{"line":122,"column":1},"end":{"line":122,"column":1}},"key":"eM3qzwbQoJ"},{"type":"inlineCode","value":"Service","position":{"start":{"line":122,"column":1},"end":{"line":122,"column":1}},"key":"iFK8TDVqbU"},{"type":"text","value":" ensures that requests are routed to the new replicas as they become ready.","position":{"start":{"line":122,"column":1},"end":{"line":122,"column":1}},"key":"p45Gxtzz25"}],"key":"YykECipiX3"},{"type":"paragraph","position":{"start":{"line":127,"column":1},"end":{"line":131,"column":1}},"children":[{"type":"text","value":"A HPA can be configured to automatically adjust the number of replicas based on any metrics that are exposed via\nthe ","position":{"start":{"line":127,"column":1},"end":{"line":127,"column":1}},"key":"V2nE312yQB"},{"type":"link","url":"https://kubernetes.io/docs/tasks/debug-application-cluster/resource-metrics-pipeline/","position":{"start":{"line":127,"column":1},"end":{"line":127,"column":1}},"children":[{"type":"text","value":"Metrics API","position":{"start":{"line":127,"column":1},"end":{"line":127,"column":1}},"key":"QfklhVfXJH"}],"urlSource":"https://kubernetes.io/docs/tasks/debug-application-cluster/resource-metrics-pipeline/","key":"nuW1mPSLYC"},{"type":"text","value":".\nBy default, this allows scaling based on the CPU or memory usage of the pods backing a service. However\nit is possible to integrate other metrics gathering systems, such as ","position":{"start":{"line":127,"column":1},"end":{"line":127,"column":1}},"key":"kS6DWzdZwp"},{"type":"link","url":"https://prometheus.io/","position":{"start":{"line":127,"column":1},"end":{"line":127,"column":1}},"children":[{"type":"text","value":"Prometheus","position":{"start":{"line":127,"column":1},"end":{"line":127,"column":1}},"key":"e3e5h3KYYH"}],"urlSource":"https://prometheus.io/","key":"Wj0uVP7dak"},{"type":"text","value":",\nto allow scaling based on any of the collected metrics (e.g. network I/O, requests per second).","position":{"start":{"line":127,"column":1},"end":{"line":127,"column":1}},"key":"YwPvXooj7K"}],"key":"ad7JYZtrLB"},{"type":"paragraph","position":{"start":{"line":133,"column":1},"end":{"line":138,"column":1}},"children":[{"type":"text","value":"By default, autoscaling is disabled in the ESGF Helm chart. To enable autoscaling for the THREDDS and\nNginx file server components, the chart allows ","position":{"start":{"line":133,"column":1},"end":{"line":133,"column":1}},"key":"cmiu8EWQ86"},{"type":"inlineCode","value":"HorizontalPodAutoscaler","position":{"start":{"line":133,"column":1},"end":{"line":133,"column":1}},"key":"v4qk4UVMxX"},{"type":"text","value":" resources to be defined using\nthe ","position":{"start":{"line":133,"column":1},"end":{"line":133,"column":1}},"key":"G9FbngqPLS"},{"type":"inlineCode","value":"data.{thredds,fileServer}.hpa","position":{"start":{"line":133,"column":1},"end":{"line":133,"column":1}},"key":"sBh6tqmmBO"},{"type":"text","value":" variables. These variables define the ","position":{"start":{"line":133,"column":1},"end":{"line":133,"column":1}},"key":"qzuYVU1Bqp"},{"type":"inlineCode","value":"spec","position":{"start":{"line":133,"column":1},"end":{"line":133,"column":1}},"key":"EYe2Y6xrc1"},{"type":"text","value":" section of the HPA, except\nfor the ","position":{"start":{"line":133,"column":1},"end":{"line":133,"column":1}},"key":"XvmcPaIhYJ"},{"type":"inlineCode","value":"scaleTargetRef","position":{"start":{"line":133,"column":1},"end":{"line":133,"column":1}},"key":"h9BGOGKgYF"},{"type":"text","value":" section which is automatically populated with the correct reference.\nFor more information about HPA configuration, see the\n","position":{"start":{"line":133,"column":1},"end":{"line":133,"column":1}},"key":"uu7q3EMoOH"},{"type":"link","url":"https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale-walkthrough/","position":{"start":{"line":133,"column":1},"end":{"line":133,"column":1}},"children":[{"type":"text","value":"Kubernetes HPA Walkthrough","position":{"start":{"line":133,"column":1},"end":{"line":133,"column":1}},"key":"wKR61iQfxK"}],"urlSource":"https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale-walkthrough/","key":"UWpSGsK2EY"},{"type":"text","value":".","position":{"start":{"line":133,"column":1},"end":{"line":133,"column":1}},"key":"fRL8zNcQYA"}],"key":"dH7wy5Pa2G"},{"type":"admonition","position":{"start":{"line":140,"column":1},"end":{"line":144,"column":1}},"children":[{"type":"admonitionTitle","children":[{"type":"text","value":"Warning","key":"iSpevV644k"}],"key":"HEHfGzzuVt"},{"type":"paragraph","position":{"start":{"line":140,"column":1},"end":{"line":140,"column":1}},"children":[],"key":"oJKokkdx2S"},{"type":"paragraph","position":{"start":{"line":142,"column":1},"end":{"line":144,"column":1}},"children":[{"type":"text","value":"In order to scale based on utilisation (as opposed to absolute value), you must define\n","position":{"start":{"line":142,"column":1},"end":{"line":142,"column":1}},"key":"w6GQ18pRBG"},{"type":"inlineCode","value":"resources.requests","position":{"start":{"line":142,"column":1},"end":{"line":142,"column":1}},"key":"SSAhTcHo4v"},{"type":"text","value":" for the service\n(see ","position":{"start":{"line":142,"column":1},"end":{"line":142,"column":1}},"key":"KXSYD7BoAP"},{"type":"link","url":"#configuring-container-resources","position":{"start":{"line":142,"column":1},"end":{"line":142,"column":1}},"children":[{"type":"text","value":"Configuring container resources","position":{"start":{"line":142,"column":1},"end":{"line":142,"column":1}},"key":"MsTsfKcnIH"}],"urlSource":"#configuring-container-resources","key":"wABfq8D6zN"},{"type":"text","value":" above).","position":{"start":{"line":142,"column":1},"end":{"line":142,"column":1}},"key":"tifFH1VTVp"}],"key":"zZGeEbnWIR"}],"kind":"warning","class":"simple","key":"vmnBNvF18u"},{"type":"paragraph","position":{"start":{"line":146,"column":1},"end":{"line":147,"column":1}},"children":[{"type":"text","value":"For example, the following configuration would attempt to keep the average CPU utilisation\nbelow 80% of the requested amount by scaling out up to a maximum of 10 replicas:","position":{"start":{"line":146,"column":1},"end":{"line":146,"column":1}},"key":"cGTuV7fSqk"}],"key":"uCyJnTWeGo"},{"type":"code","lang":"yaml","value":"data:\n  thredds:\n    hpa:\n      minReplicas: 1\n      maxReplicas: 10\n      metrics:\n        - type: Resource\n          resource:\n            name: cpu\n            target:\n              type: Utilization\n              averageUtilization: 80\n\n  fileServer:\n    hpa:\n      minReplicas: 1\n      maxReplicas: 10\n      metrics:\n        - type: Resource\n          resource:\n            name: cpu\n            target:\n              type: Utilization\n              averageUtilization: 80","position":{"start":{"line":149,"column":1},"end":{"line":174,"column":1}},"key":"xsq69PFinJ"},{"type":"heading","depth":3,"position":{"start":{"line":176,"column":1},"end":{"line":176,"column":1}},"children":[{"type":"text","value":"Using existing THREDDS catalogs","position":{"start":{"line":176,"column":1},"end":{"line":176,"column":1}},"key":"OqHKijTGhC"}],"identifier":"using-existing-thredds-catalogs","label":"Using existing THREDDS catalogs","html_id":"using-existing-thredds-catalogs","implicit":true,"key":"NS6j4F8kKj"},{"type":"paragraph","position":{"start":{"line":178,"column":1},"end":{"line":184,"column":1}},"children":[{"type":"text","value":"The data node can be configured to serve data based on pre-existing THREDDS catalogs, for\nexample those generated by the ESGF publisher. To do this, you must specify the volume\ncontaining the catalogs using the variable ","position":{"start":{"line":178,"column":1},"end":{"line":178,"column":1}},"key":"UZ2HVnWpUL"},{"type":"inlineCode","value":"data.thredds.catalogVolume","position":{"start":{"line":178,"column":1},"end":{"line":178,"column":1}},"key":"B2j13kQ5qj"},{"type":"text","value":". This volume must\nbe available to all nodes where THREDDS pods might be scheduled and must be able to be\nmounted in multiple pods at once, for example a ","position":{"start":{"line":178,"column":1},"end":{"line":178,"column":1}},"key":"HbFVjrrGf5"},{"type":"inlineCode","value":"hostPath","position":{"start":{"line":178,"column":1},"end":{"line":178,"column":1}},"key":"oc5XIMwMm3"},{"type":"text","value":" using a shared filesystem.\nThis variable should contain the keys ","position":{"start":{"line":178,"column":1},"end":{"line":178,"column":1}},"key":"rdE9igxfVL"},{"type":"inlineCode","value":"volumeSpec","position":{"start":{"line":178,"column":1},"end":{"line":178,"column":1}},"key":"B319pz9ZAt"},{"type":"text","value":" and ","position":{"start":{"line":178,"column":1},"end":{"line":178,"column":1}},"key":"tjJQ6X0V47"},{"type":"inlineCode","value":"mountOptions","position":{"start":{"line":178,"column":1},"end":{"line":178,"column":1}},"key":"ALnGhVP52M"},{"type":"text","value":", which have the\nsame meaning as for ","position":{"start":{"line":178,"column":1},"end":{"line":178,"column":1}},"key":"CXby4IcZ4x"},{"type":"inlineCode","value":"data.mounts","position":{"start":{"line":178,"column":1},"end":{"line":178,"column":1}},"key":"i9xdpzQl7x"},{"type":"text","value":" above, e.g.:","position":{"start":{"line":178,"column":1},"end":{"line":178,"column":1}},"key":"yQlG02pdHM"}],"key":"YW1C7ssdC8"},{"type":"code","lang":"yaml","value":"data:\n  thredds:\n    catalogVolume:\n      volumeSpec:\n        hostPath:\n          path: /path/to/shared/catalogs\n      mountOptions:\n        mountPropagation: HostToContainer","position":{"start":{"line":186,"column":1},"end":{"line":195,"column":1}},"key":"KrG8LbkuUE"},{"type":"admonition","position":{"start":{"line":197,"column":1},"end":{"line":200,"column":1}},"children":[{"type":"admonitionTitle","children":[{"type":"text","value":"Note","key":"zwzrOn9Yv0"}],"key":"ZVwua2Uypf"},{"type":"paragraph","position":{"start":{"line":197,"column":1},"end":{"line":197,"column":1}},"children":[],"key":"G7AV5EZE6v"},{"type":"paragraph","position":{"start":{"line":199,"column":1},"end":{"line":200,"column":1}},"children":[{"type":"text","value":"You must still configure ","position":{"start":{"line":199,"column":1},"end":{"line":199,"column":1}},"key":"qyFqB9qovP"},{"type":"inlineCode","value":"data.mounts","position":{"start":{"line":199,"column":1},"end":{"line":199,"column":1}},"key":"kaJ3dQk0ke"},{"type":"text","value":" and ","position":{"start":{"line":199,"column":1},"end":{"line":199,"column":1}},"key":"xCA0fA4LD9"},{"type":"inlineCode","value":"data.datasets","position":{"start":{"line":199,"column":1},"end":{"line":199,"column":1}},"key":"cWIhHIjcjU"},{"type":"text","value":" as above, except in this case the\ndatasets should correspond the to the ","position":{"start":{"line":199,"column":1},"end":{"line":199,"column":1}},"key":"FBM8cKc9aB"},{"type":"inlineCode","value":"datasetRoot","position":{"start":{"line":199,"column":1},"end":{"line":199,"column":1}},"key":"S6fD6Pym22"},{"type":"text","value":"s in your THREDDS catalogs.","position":{"start":{"line":199,"column":1},"end":{"line":199,"column":1}},"key":"tgUlgIsjea"}],"key":"FRIsIkoRA3"}],"kind":"note","class":"simple","key":"hDCNrPWxuU"},{"type":"paragraph","position":{"start":{"line":202,"column":1},"end":{"line":204,"column":1}},"children":[{"type":"text","value":"When the catalogs change, run the Helm chart in order to create new pods which will\nload the new catalogs. This will be done using a rolling upgrade with no downtime - the\nold pods will continue to serve requests with the old catalogs until new pods are ready.","position":{"start":{"line":202,"column":1},"end":{"line":202,"column":1}},"key":"WUdvpGZa4l"}],"key":"w9g0yqsQev"},{"type":"paragraph","position":{"start":{"line":206,"column":1},"end":{"line":209,"column":1}},"children":[{"type":"text","value":"For large catalogs, you may also need to adjust the startup time for the THREDDS container\nas THREDDS must build the catalog cache before it can start serving requests. To do this,\nspecify ","position":{"start":{"line":206,"column":1},"end":{"line":206,"column":1}},"key":"OcnLzv13XS"},{"type":"inlineCode","value":"data.thredds.startTimeout","position":{"start":{"line":206,"column":1},"end":{"line":206,"column":1}},"key":"TAl48qmQN7"},{"type":"text","value":", which specifies the number of seconds to wait for\nTHREDDS to start before assuming there is a problem and trying again (default ","position":{"start":{"line":206,"column":1},"end":{"line":206,"column":1}},"key":"AXbSongzOw"},{"type":"inlineCode","value":"300","position":{"start":{"line":206,"column":1},"end":{"line":206,"column":1}},"key":"kFBFIf9ueL"},{"type":"text","value":"):","position":{"start":{"line":206,"column":1},"end":{"line":206,"column":1}},"key":"VtFkEtaJ64"}],"key":"Veeg54zXKz"},{"type":"code","lang":"yaml","value":"data:\n  thredds:\n    startTimeout: 3600  # Large catalogs may take an hour or more","position":{"start":{"line":211,"column":1},"end":{"line":215,"column":1}},"key":"ItXDoQsLYI"},{"type":"heading","depth":3,"position":{"start":{"line":217,"column":1},"end":{"line":217,"column":1}},"children":[{"type":"text","value":"Improving pod startup time for large catalogs","position":{"start":{"line":217,"column":1},"end":{"line":217,"column":1}},"key":"FyOKUlbR09"}],"identifier":"improving-pod-startup-time-for-large-catalogs","label":"Improving pod startup time for large catalogs","html_id":"improving-pod-startup-time-for-large-catalogs","implicit":true,"key":"s55HEVLxN8"},{"type":"paragraph","position":{"start":{"line":219,"column":1},"end":{"line":224,"column":1}},"children":[{"type":"text","value":"Pods in Kubernetes are ephemeral, meaning they do not preserve state across restarts.\nThis includes the THREDDS caches, meaning that every time a pod starts it will spend time\nrebuilding the catalog cache before serving requests, even if the catalogs have not changed.\nThis is exacerbated by the fact that the catalogs will likely be on network-attached-storage\nin order to facilitate sharing across nodes, meaning higher latency for stat and read\noperations.","position":{"start":{"line":219,"column":1},"end":{"line":219,"column":1}},"key":"L8N2Kg8Hhs"}],"key":"a4v4oBEoU7"},{"type":"paragraph","position":{"start":{"line":226,"column":1},"end":{"line":229,"column":1}},"children":[{"type":"text","value":"For large catalogs, this can result in THREDDS pods taking an hour or more to start. This is not\nmerely an inconvenience - in order to benefit from advanced features in Kubernetes such as\nrecovery from failure and demand-based autoscaling, pods must start quickly in order to begin\ntaking load as soon as possible. There are two things that can be done to address this problem:","position":{"start":{"line":226,"column":1},"end":{"line":226,"column":1}},"key":"IHydf0tay9"}],"key":"LTFFaxOfks"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":231,"column":1},"end":{"line":233,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":231,"column":1},"end":{"line":231,"column":1}},"children":[{"type":"text","value":"Keep a copy of the catalogs on the local disk of each node that may have THREDDS pods scheduled","position":{"start":{"line":231,"column":1},"end":{"line":231,"column":1}},"key":"EKqMGtqE3Z"}],"key":"vlGZuhnC1E"},{"type":"listItem","spread":true,"position":{"start":{"line":232,"column":1},"end":{"line":233,"column":1}},"children":[{"type":"text","value":"Pre-build the catalog cache (again on the local disk of each node) and use it to seed the cache for new THREDDS pods","position":{"start":{"line":232,"column":1},"end":{"line":232,"column":1}},"key":"SNCQWtrgaB"}],"key":"hJsjM3xPBP"}],"key":"AwsmwK4U1x"},{"type":"paragraph","position":{"start":{"line":234,"column":1},"end":{"line":243,"column":1}},"children":[{"type":"text","value":"In an ESGF deployment, this is acheived by having a\n","position":{"start":{"line":234,"column":1},"end":{"line":234,"column":1}},"key":"zpc2NOLNXl"},{"type":"link","url":"https://kubernetes.io/docs/concepts/workloads/controllers/daemonset/","position":{"start":{"line":234,"column":1},"end":{"line":234,"column":1}},"children":[{"type":"text","value":"DaemonSet","position":{"start":{"line":234,"column":1},"end":{"line":234,"column":1}},"key":"P2PRGnlNnD"}],"urlSource":"https://kubernetes.io/docs/concepts/workloads/controllers/daemonset/","key":"OjhLBGjY3H"},{"type":"text","value":" that runs on\neach node. When the Helm chart is run or a new node is added to the cluster, this ","position":{"start":{"line":234,"column":1},"end":{"line":234,"column":1}},"key":"RBqBoo9CsU"},{"type":"inlineCode","value":"DaemonSet","position":{"start":{"line":234,"column":1},"end":{"line":234,"column":1}},"key":"eiBKQzpVx1"},{"type":"text","value":"\nwill syncronise the THREDDS catalogs to each node’s local disk and run THREDDS to build the catalog\ncache. The THREDDS pods will wait for the ","position":{"start":{"line":234,"column":1},"end":{"line":234,"column":1}},"key":"nbQARWBOLr"},{"type":"inlineCode","value":"DaemonSet","position":{"start":{"line":234,"column":1},"end":{"line":234,"column":1}},"key":"LRebnziTzj"},{"type":"text","value":" to finish updating the cache before starting,\nusing the pre-built cache as a seed for their own local caches. While they are waiting, the old\npods will continue to serve requests using the old catalogs, so the upgrade is zero-downtime.\nUsing this approach, copying the catalogs to local disk and rebuilding the cache are one-time\noperations and the THREDDS pods start much faster (less than one minute for a large catalog at\nCEDA in testing).","position":{"start":{"line":234,"column":1},"end":{"line":234,"column":1}},"key":"QzwOXJYAYt"}],"key":"YAwCTipuFJ"},{"type":"paragraph","position":{"start":{"line":245,"column":1},"end":{"line":245,"column":1}},"children":[{"type":"text","value":"To enable local caching of catalogs for a deployment, just set ","position":{"start":{"line":245,"column":1},"end":{"line":245,"column":1}},"key":"WDaD5aH029"},{"type":"inlineCode","value":"data.thredds.localCache.enabled","position":{"start":{"line":245,"column":1},"end":{"line":245,"column":1}},"key":"c68H433E1P"},{"type":"text","value":":","position":{"start":{"line":245,"column":1},"end":{"line":245,"column":1}},"key":"g2BIISQvMz"}],"key":"qz0Ayo4lLs"},{"type":"code","lang":"yaml","value":"data:\n  thredds:\n    localCache:\n      enabled: true","position":{"start":{"line":247,"column":1},"end":{"line":252,"column":1}},"key":"G93erkAC3R"}],"key":"bXR0BaIvw5"}],"key":"oz7qv3yQo3"},"references":{"cite":{"order":[],"data":{}}}}